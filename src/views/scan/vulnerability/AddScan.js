import React, { useState } from 'react';
import { Row, Col, Tabs, Tab, Nav, Form } from 'react-bootstrap';
import ModuleNotification from '../../../components/Widgets/Statistic/Notification';
import { useEffect } from 'react';
import axiosClient from '../../../axiosClient';
import './vul.css';
import { Link, useLocation } from 'react-router-dom';
import nginx from '../../../assets/images/user/nginx.jpg';
import acunetix from '../../../assets/images/user/acunetix.jpg';
import { ButtonToolbar, Button, OverlayTrigger, Tooltip, Dropdown, DropdownButton, Card } from 'react-bootstrap';
import Modal from 'react-bootstrap/Modal';
import { useHistory } from "react-router-dom";

const AddScan = () => {
  const history = useHistory();
  const [listTargets, setlistTargets] = useState([]);
  const [task, setTask] = useState('Chạy');
  const [name, setName] = useState();
  const [description, setDescription] = useState();
  const [target, setTarget] = useState();
  const [show, setShow] = useState(false);
  const handleClose = () => setShow(false);
  
  const handleShow = () => setShow(true);
  const [listEngine, setListEngine] = useState([]);

  useEffect(() => {
    async function getItem() {
      const res = await axiosClient.get('targets');
      // console.log(res);
      setlistTargets((listTargets) => [...res.data.items]);
    }
    async function getEngine() {
      const res = await axiosClient.get('engines');
      // console.log('engine',res.data);
      const data = res.data.map((item)=>{
        return {...item,select:false}
      })
      setListEngine(data);
      console.log('listEngine', listEngine);
    }
    
    getItem();
    getEngine();
  }, []);
  console.log(listEngine);
  const buttonOptions = [{ variant: 'secondary', icon: 'feather icon-camera mx-1' }];
  const handleButtonClick = (eventKey) => {
    if (eventKey === '1') {
      // Nếu người dùng chọn "Chạy", cập nhật giá trị của "title" và "task" là "Chạy"
      setTask('Chạy');
      runScan();

    } else if (eventKey === '2') {
      // Nếu người dùng chọn "Lưu", cập nhật giá trị của "title" là "Lưu" và "task" là "Lưu"
      setTask('Lưu');
      createScan();
    }
    
  };
  const basicDropdownButton = buttonOptions.map((button) => {
    return (
      <DropdownButton
        title={task}
        // variant={button.variant}
        id={`dropdown-variants-${button.variant}`}
        key={button.variant}
      >
        <Dropdown.Item eventKey="1" onClick={() => handleButtonClick('1')}>
          Chạy
        </Dropdown.Item>
        <Dropdown.Item eventKey="2" onClick={() => handleButtonClick('2')}>
          Lưu
        </Dropdown.Item>
      </DropdownButton>
    );
  });
  const cancel = (e) => {
    // e.preventDefault();
    // console.log(url, name);
    console.log(name, description);
    setName('');
    setDescription('');
    setTarget('');
  };
  function setting() {
    setShow(true);
  }
  
  async function toggleEngineUsage(engineName) {
    // console.log('engineName', engineName);
    // console.log(listEngineSelected.indexOf(engineName))
    // const engineIndex = listEngineSelected.indexOf(engineName);
    // if (engineIndex == -1) {
    //   // Nếu engine chưa được chọn, thêm engine vào danh sách
    //   setListEngineSelected([...listEngineSelected, engineName]);
    // } else {
    //   // Nếu engine đã được chọn, xoá engine khỏi danh sách
    //   setListEngineSelected(listEngineSelected.filter(engine  => engine  !== engineName));
    // }
    // console.log('engine', listEngineSelected);
    const check = listEngine.map((item)=>{
      if(item.name === engineName){
        return {...item,select:!item.select}
      }
      else{
        return item
      }
    })
    setListEngine(check)
  }
  async function createScan() {
    const engine = listEngine.filter(item=>item.select)
    const req = engine.map(item=>{
      return {
        "name":item.name,
        "cmd":""
      }
    })
    const data = {target_id:target,
      name:name,
      describe:description,
      config: JSON.stringify({
        engines: req
      })
    };
    console.log(data);
    axiosClient.post("scans", data).then(res=>{
      // console.log(res)
      if(res.status===201){
        history.push("/scan/vulnerability/result"); 
      }else{
        alert("Đã xảy ra lỗi!")
      }
    })
  }

  async function runScan() {
    const engine = listEngine.filter(item=>item.select)
    const req = engine.map(item=>{
      return {
        "name":item.name,
        "cmd":""
      }
    })
    const data = {target_id:target,
      name:name,
      describe:description,
      config: JSON.stringify({
        engines: req
      })
    };
    console.log(data);
    axiosClient.post("scans", data).then(res=>{
      console.log(res.data.id)
      const id = res.data.id
      if(id){
        axiosClient.get(`scans/${id}/start`).then(res=>{
          // console.log(res)
          if(res.status===201){
            history.push("/scan/vulnerability/result"); 
          }else{
            alert("Đã xảy ra lỗi!")
          }
        })
      }      
    })
  }
  return (
    <React.Fragment>
      <Modal show={show} onHide={handleClose}>
        <Modal.Header closeButton>
          <Modal.Title>Cấu hình</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form>
            <div className="form-group">
              <label>Nội dung cấu hình - cmd</label>
              <input className="form-control url" placeholder="-A -T4 ${target} -oN /tmp/nmap/output.txt" />
            </div>
          </Form>
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={handleClose}>
            Close
          </Button>
          <Button variant="primary">Lưu</Button>
        </Modal.Footer>
      </Modal>
     
      <Row>
        <Col>
          <Row>
            <h5 className="mt-4 my-title">Rà soát mới</h5>
            <div style={{ display: 'flex', alignItems: 'flex-end', paddingLeft: '20px' }}>
              <ButtonToolbar className="my-button">{basicDropdownButton}</ButtonToolbar>
              <Button variant={'outline-primary'} className="my-button" onClick={(e) => cancel()}>
                Hủy bỏ
              </Button>
            </div>
          </Row>
          <hr />
          <Col md="12">
            <Tabs variant="pills" defaultActiveKey="home" className="mb-3">
              <Tab eventKey="home" title="CHỌN ĐỐI TƯỢNG">
                <Col md="8">
                  <div className="mb-3">
                    <label>
                      <span style={{ fontWeight: 'bold' }}>Tên rà quét</span> <span style={{ fontStyle: 'italic' }}>(Bắt buộc)</span>
                    </label>
                    <input
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                      className="form-control email"
                      placeholder="Dò quét server 01"
                    />
                    <label style={{ marginTop: 5 }}>
                      <span style={{ fontStyle: 'italic', fontSize: 12 }}>Giúp phân biệt các lần rà quét khác nhau của 1 mục tiêu</span>
                    </label>
                  </div>
                  <div className="mb-3">
                    <span style={{ fontWeight: 'bold' }}>Mô tả</span>
                    <input
                      value={description}
                      onChange={(e) => setDescription(e.target.value)}
                      className="form-control"
                      placeholder="Lần rà quét này để kiểm tra server tháng 02/2023"
                    />
                  </div>
                  <div className="mb-3">
                    <label>
                      <span style={{ fontWeight: 'bold' }}>Mục tiêu</span> <span style={{ fontStyle: 'italic' }}>(Bắt buộc)</span>
                    </label>
                    <div>
                      <Row>
                        <select
                          class="form-control name-domain "
                          style={{
                            marginLeft: 20,
                            width: '80%'
                            // height: '40px',
                          }}
                          onChange={(event) => setTarget(event.target.value)}
                        >
                          {listTargets &&
                            listTargets.map((item) => {
                              return (
                                <option value={item.id} onClick={() => setTarget(item.id)}>
                                  {item.address}
                                </option>
                              );
                            })}
                        </select>
                        <Link
                          title="Thêm mới đối tượng"
                          to={'/scan/website'}
                          className="feather icon-plus-circle text-primary f-15 m-r-5"
                          style={{ fontSize: '30px', marginLeft: 10, marginTop: 5 }}
                        ></Link>
                      </Row>
                    </div>
                    <label style={{ marginTop: 5 }}>
                      <span style={{ fontStyle: 'italic', fontSize: 12 }}>Địa chỉ URL hoặc IP của mục tiêu</span>
                    </label>
                  </div>
                  <div>
                    <Link
                      title="Danh sách rà soát"
                      to={'/scan/vulnerability/result'}
                      className="feather icon-chevron-left text-primary f-15 m-r-5"
                      style={{ fontSize: '30px' }}
                    ></Link>
                  </div>
                </Col>
              </Tab>
              <Tab eventKey="profile" title="CHỌN ENGINE">
                {listEngine &&
                  listEngine.map((item) => {
                    return (
                      <p>
                        <Row className="btn-page">
                          <Col md="12">
                            <Card>
                              <Row>
                                <Col sm={2}>
                                  <Row style={{ marginLeft: '25%' }}>
                                    <div className="container-fuild">
                                      <img
                                        className="acunetix"
                                        style={{ width: '100%', marginTop: '30%' }}
                                        src={item.icon}
                                        alt="acunetix"
                                      />
                                    </div>
                                  </Row>
                                </Col>
                                <Col sm={8}>
                                  <div style={{ marginBottom: '20px' }}>
                                    <Col sm={10}>
                                      <Row style={{ marginLeft: '10%' }}>
                                        <Form.Group>
                                          <h5>
                                            <Form.Label></Form.Label>
                                          </h5>
                                          <p style={{ fontWeight: 'bold', fontSize: '18px' }}>{item.name}</p>
                                          <p>
                                            By{' '}
                                            <span style={{ fontWeight: 'normal', fontStyle: 'italic', color: 'blue' }}>{item.author}</span>
                                          </p>
                                          <label>{item.describe}</label>
                                        </Form.Group>
                                      </Row>
                                     
                                    </Col>
                                  </div>
                                </Col>

                                <Col sm={2}>
                                  <Row style={{ marginLeft: '-20%', marginTop: '20%' }}>
                                    <Col>
                                      <Button
                                        className="btn btn-info"
                                        style={{ marginLeft: '-25%', width: '150px', height: '50px' }}
                                        onClick={(e) => setting()}
                                      >
                                        <Link to="#" className="feather icon-shopping-cart text-white f-25 m-r-5"></Link>
                                        Cấu hình
                                      </Button>
                                    </Col>
                                    <Col>
                                      <Button className="btn btn-dark" 
                                      style={{ marginLeft: '-25%', width: '150px', height: '50px' }}
                                      onClick={() => toggleEngineUsage(item.name)}>
                                        <Link to="#" className="feather text-white f-25 m-r-5"></Link>
                                        {item.select ? "Không Sử dụng" : "Sử dụng"}
                                      </Button>
                                    </Col>
                                  </Row>
                                </Col>
                              </Row>
                            </Card>
                          </Col>
                        </Row>
                      </p>
                    );
                  })}

                {/* <p>
                  <Row className="btn-page">
                    <Col md="12">
                      <Card>
                        <Row>
                          <Col sm={2}>
                            <Row style={{ marginLeft: '25%' }}>
                              <div className="container-fuild">
                                <img className="nginx" style={{ width: '90%' }} src={nginx} alt="nginx" />
                              </div>
                            </Row>
                          </Col>
                          <Col sm={8}>
                            <div style={{ marginBottom: '20px' }}>
                              <Col sm={10}>
                                <Row style={{ marginLeft: '10%' }}>
                                  <Form.Group>
                                    <h5>
                                      <Form.Label></Form.Label>
                                    </h5>
                                    <p style={{ fontWeight: 'bold', fontSize: '18px' }}>NUCLEI (Mặc định)</p>
                                    <p>
                                      By <span style={{ fontWeight: 'normal', fontStyle: 'italic', color: 'blue' }}>DunDun</span>
                                    </p>
                                  </Form.Group>
                                  <label>
                                    (Mô tả engine) Acunetix là phần mềm quét lỗ hổng website hiệu quả nhất hiện nay gồm SQL Injection, Cross
                                    Site Scripting và nhiều lỗ hổng khác
                                  </label>
                                </Row>
                              </Col>
                            </div>
                          </Col>
                          
                          <Col sm={2}>
                            <Row style={{ marginLeft: '-20%', marginTop:'20%' }}>
                              <Col>
                                <Button className="btn btn-info" style={{ marginLeft: '-25%', width: "150px", height:'50px' }}>
                                  <Link to="#" className="feather icon-shopping-cart text-white f-25 m-r-5"></Link>
                                  Cấu hình
                                </Button>
                              </Col>
                              <Col>
                                <Button className="btn btn-dark" style={{ marginLeft: '-25%' , width: "150px", height:"50px"}}>
                                  <Link to="#" className="feather icon-heart text-white f-25 m-r-5"></Link>
                                  Sử dụng
                                </Button>
                              </Col>
                            </Row>
                          </Col>
                        </Row>
                      </Card>
                    </Col>
                  </Row>
                </p>
                <p>
                  <Row className="btn-page">
                    <Col md="12">
                      <Card>
                        <Row>
                          <Col sm={2}>
                            <Row style={{ marginLeft: '25%' }}>
                              <div className="container-fuild">
                                <img className="acunetix" style={{ width: '100%' , marginTop:'30%'}} src={acunetix} alt="acunetix" />
                              </div>
                            </Row>
                          </Col>
                          <Col sm={8}>
                            <div style={{ marginBottom: '20px' }}>
                              <Col sm={10}>
                                <Row style={{ marginLeft: '10%' }}>
                                  <Form.Group>
                                    <h5>
                                      <Form.Label></Form.Label>
                                    </h5>
                                    <p style={{ fontWeight: 'bold', fontSize: '18px' }}>ACUNETIX (Mặc định)</p>
                                    <p>
                                      By <span style={{ fontWeight: 'normal', fontStyle: 'italic', color: 'blue' }}>DunDun</span>
                                    </p>
                                  </Form.Group>
                                  <label>
                                    (Mô tả engine) Acunetix là phần mềm quét lỗ hổng website hiệu quả nhất hiện nay gồm SQL Injection, Cross
                                    Site Scripting và nhiều lỗ hổng khác
                                  </label>
                                </Row>
                              </Col>
                            </div>
                          </Col>
                          
                          <Col sm={2}>
                            <Row style={{ marginLeft: '-20%', marginTop:'20%' }}>
                              <Col>
                                <Button className="btn btn-info" style={{ marginLeft: '-25%', width: "150px", height:'50px' }}>
                                  <Link to="#" className="feather icon-shopping-cart text-white f-25 m-r-5"></Link>
                                  Cấu hình
                                </Button>
                              </Col>
                              <Col>
                                <Button className="btn btn-dark" style={{ marginLeft: '-25%' , width: "150px", height:"50px"}}>
                                  <Link to="#" className="feather icon-heart text-white f-25 m-r-5"></Link>
                                  Sử dụng
                                </Button>
                              </Col>
                             
                            </Row>
                          </Col>
                          
                        </Row>
                      </Card>
                    </Col>
                  </Row>
                </p> */}
              </Tab>
            </Tabs>
          </Col>
        </Col>
      </Row>
    </React.Fragment>
  );
};

export default AddScan;
